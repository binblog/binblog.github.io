	<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>java序列化过程简析 | binecy</title>
  <meta name="author" content="bin">
  
  <meta name="description" content="文章通过一个简单的小栗子，简单分析了java序列化的过程
一个小栗子public class User implements Serializable{
    private static final long serialVersionUID = -8327620862083656937L;

">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="java序列化过程简析"/>
  <meta property="og:site_name" content="binecy"/>

  
  
		<!-- favicon -->
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.png">
		<meta name="theme-color" content="#009688">
		<!-- favicon end -->
    <!-- <link href="/favicon.ico" rel="icon"> -->
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  

  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>

 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">binecy</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
                <li>
                    <a href="/about" title="">
                    <i class="fa fa-info-circle"></i>关于
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	
	<div class="col-md-9">
	

		<div class="content">
			<!-- index -->
		   

			  		<h2>java序列化过程简析</h2>
					
					<div>
						<span class="post-time">2017-02-08 16:34:33</span>
					</div>	
					

					<div class="article-content">
						<p>文章通过一个简单的小栗子，简单分析了java序列化的过程</p>
<h2 id="一个小栗子"><a href="#一个小栗子" class="headerlink" title="一个小栗子"></a>一个小栗子</h2><pre><code>public class User implements Serializable{
    private static final long serialVersionUID = -8327620862083656937L;


    private String name;

    // getter and setter

}
</code></pre><p>序列化</p>
<pre><code>public void serialize() {
    User user = new User();
    user.setName(&quot;bin&quot;);
    FileOutputStream fileOut = new  FileOutputStream(&quot;user.ser&quot;);
    ObjectOutputStream out = new ObjectOutputStream(fileOut);
    out.writeObject(user);
    out.close();
    fileOut.close();
}
</code></pre><p>可以看到相对目录下生成了user.ser文件，内容如下<br><img src="java-serializable/1.png" alt=""></p>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p>简单记录一下该栗子中ObjectOutputStream生成文件的过程。</p>
<pre><code>public ObjectOutputStream(OutputStream out) ... {
    ...
    writeStreamHeader();    // 
}

protected void writeStreamHeader() ... {
    bout.writeShort(STREAM_MAGIC);    // 魔法数0xac ed
    bout.writeShort(STREAM_VERSION);    // 版本0x00 05
}
</code></pre><p>FileOutputStream.writeObject</p>
<pre><code>public final void writeObject(Object obj)... {
    ...
    writeObject0(obj, false);
}

private void writeObject0(Object obj, boolean unshared) {
    ...
    ObjectStreamClass desc;
    desc = ObjectStreamClass.lookup(cl, true);

    if (obj instanceof String) {
        writeString((String) obj, unshared);
    } else if (cl.isArray()) {
        writeArray(obj, desc, unshared);
    } else if (obj instanceof Enum) {
        writeEnum((Enum&lt;?&gt;) obj, desc, unshared);
    } else if (obj instanceof Serializable) { // 序列化对象必须实现Serializable接口
        writeOrdinaryObject(obj, desc, unshared);
    } else {
        ...
    }
}
</code></pre><p>ObjectStreamClass用于存储一些Class解析结果，如是否继承了Serializable， 是否为enum，字段信息等。<code>ObjectStreamClass.lookup</code>通过反射获取到这些方法，存储在ObjectStreamClass中。</p>
<pre><code>private void writeOrdinaryObject(Object obj,ObjectStreamClass desc,boolean unshared) {
    ...
    bout.writeByte(TC_OBJECT);    // new object标志:0x73            
    writeClassDesc(desc, false); // 记录class描述

    writeSerialData(obj, desc);    // 记录字段内容
}
</code></pre><h3 id="记录class描述"><a href="#记录class描述" class="headerlink" title="记录class描述"></a>记录class描述</h3><pre><code>private void writeClassDesc(ObjectStreamClass desc, boolean unshared) ... {
    int handle;
    if (desc == null) {
        writeNull();
    } else if (!unshared &amp;&amp; (handle = handles.lookup(desc)) != -1) {
        writeHandle(handle);
    } else if (desc.isProxy()) {
        writeProxyDesc(desc, unshared);
    } else {
        writeNonProxyDesc(desc, unshared);
    }
}

private void writeNonProxyDesc(ObjectStreamClass desc, boolean unshared) {
    bout.writeByte(TC_CLASSDESC);    // new Class Descriptor:0x72
    ...
    writeClassDescriptor(desc);    // class描述信息

    bout.writeByte(TC_ENDBLOCKDATA); // object结束标志:0x78

    writeClassDesc(desc.getSuperDesc(), false);    // 记录父类描述: 0x70

}

protected void writeClassDescriptor(ObjectStreamClass desc)
    throws IOException
{
    desc.writeNonProxy(this);
}

void writeNonProxy(ObjectOutputStream out) {
    // 记录class name:serialize.User (000E73657269616C697A652E55736572)
    out.writeUTF(name);    
    // 记录VersionUID(8C6E58F2935F1317)
    out.writeLong(getSerialVersionUID());    

    byte flags = 0;
    ... 
    out.writeByte(flags);    // 相关标志:0x02
    out.writeShort(fields.length);    // 0x0001

    // 记录所有字段的描述
    for (int i = 0; i &lt; fields.length; i++) {
            ObjectStreamField f = fields[i];
            out.writeByte(f.getTypeCode());    // L:4C
            // 字段名name:0004 6E 61 6D 65(0004是字节个数)
            out.writeUTF(f.getName());    
            if (!f.isPrimitive()) {
                // 字段描述Ljava/lang/String;
                //  74 0012 4C6A6176612F6C616E672F537472696E673B
                // 0x74为string标志 0x0012为字节个数
                out.writeTypeString(f.getTypeString());    
            }
        }

}
</code></pre><h3 id="记录字段内容"><a href="#记录字段内容" class="headerlink" title="记录字段内容"></a>记录字段内容</h3><pre><code>private void writeSerialData(Object obj, ObjectStreamClass desc) {
    if (slotDesc.hasWriteObjectMethod()) {
        slotDesc.invokeWriteObject(obj, this);
    } else {
        defaultWriteFields(obj, slotDesc);
    }    
}

private void defaultWriteFields(Object obj, ObjectStreamClass desc) {
    desc.getPrimFieldValues(obj, primVals);    // 原始数据，如int，double
    bout.write(primVals, 0, primDataSize, false);

    // 处理非原始对象，如String，数组，Object
    desc.getObjFieldValues(obj, objVals);    
    // 记录bin的字段值bin: 0003 62 69 6E
    writeObject0(objVals[i], fields[numPrimFields + i].isUnshared());    
}
</code></pre><p>需要注意的,<code>writeSerialData()</code>中,会通过<code>slotDesc.hasWriteObjectMethod()</code>检查被序列化的对象是否实现了签名为<code>private void writeObject(ObjectOutputStream out)</code>的方法， 如果有该方法，将直接调用该方法。该方法可以提供给用户自定义字段内容的存储格式，如密码的加密存储。</p>
<p>同样，ObjectInputStream.readObject时，也会检查反序列化对象是否实现了签名为<code>private void readObject(ObjectInputStream in)</code>的方法，如果有该方法， 将直接该方法反序列化。该方法可实现反序列化时单例的需求。</p>

					</div>
					
			  <!-- about -->
			  
		</div>

		<!-- pagination -->
	  

		<div class="comment-section">
  
  
   <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="_posts/java-serializable.md" data-title="java序列化过程简析" data-url="https://binecy.coding.me/java-serializable/"></div>
    <!-- 多说评论框 end -->
   <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'tanke773'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  


</div>
	</div>

	
		<div class="col-md-3">
			<div id="toc" ></div>
		</div>
	

</div>


		<footer>
			

<!--
<p>
  &copy; 2017 <a href="https://binecy.coding.me"> bin </a>
</p>
-->
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
